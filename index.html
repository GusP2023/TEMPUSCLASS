<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1e3a8a">
    <title>MusicClass Manager</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiTXVzaWNDbGFzcyBNYW5hZ2VyIiwic2hvcnRfbmFtZSI6Ik11c2ljQ2xhc3MiLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2ZmZmZmZiIsInRoZW1lX2NvbG9yIjoiIzFlM2E4YSIsImljb25zIjpbeyJzcmMiOiJpY29uLnBuZyIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9wbmcifV19">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1e3a8a;
            --primary-dark: #1e2a5a;
            --accent: #f59e0b;
            --bg-main: #f8fafc;
            --bg-secondary: #e2e8f0;
            --text: #1e293b;
            --text-light: #64748b;
            --success: #10b981;
            --error: #ef4444;
            --white: #ffffff;
            --border: #cbd5e1;
            --recovery: #8b5cf6;
            --license: #06b6d4;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-main);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: var(--primary);
            color: var(--white);
            padding: 0.5rem 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .header h1 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .week-nav {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .week-nav button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: var(--white);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
            font-size: 1.25rem;
        }

        .week-nav button:hover {
            background: rgba(255,255,255,0.3);
        }

        .week-nav span {
            font-size: 0.8rem;
            min-width: 100px;
            text-align: center;
        }

        .week-days {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 2px;
            margin-top: 0.5rem;
            width: 100%;
        }

        .week-day-header {
            text-align: center;
            font-size: 0.7rem;
            padding: 0.2rem 0.1rem;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            min-width: 0;
            overflow: hidden;
        }

        .week-day-header.today {
            background: rgba(255,255,255,0.3);
            font-weight: 600;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            overflow: hidden;
            position: relative;
            padding-bottom: 120px;
        }

        .schedule-container {
            height: 100%;
            overflow-y: auto;
            overflow-x: auto;
            padding-bottom: 100px;
        }

        .time-slot {
            background: var(--white);
            padding: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-light);
            text-align: center;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 50px;
        }

        .slot {
            background: var(--white);
            min-height: 55px;
            min-width: 50px;
            padding: 0.25rem;
            cursor: pointer;
            transition: background 0.3s;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .slot.empty {
            font-size: 0.7rem;
            color: var(--text-light);
            text-align: center;
            font-weight: 500;
        }

        .slot:hover {
            background: var(--bg-main);
        }

        .slot.disabled {
            background: var(--bg-secondary);
            cursor: not-allowed;
        }

        .slot.disabled:hover {
            background: var(--bg-secondary);
        }

        .class-block {
            padding: 0.25rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-align: center;
            cursor: pointer;
        }

        .class-block.regular {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
        }

        .class-block.recovery {
            background: linear-gradient(135deg, var(--recovery) 0%, #7c3aed 100%);
            color: var(--white);
        }

        .class-block.license {
            background: linear-gradient(135deg, var(--license) 0%, #0891b2 100%);
            color: var(--white);
            opacity: 0.7;
        }

        .class-name {
            font-weight: 600;
            font-size: 0.65rem;
            line-height: 1;
        }

        .class-type {
            font-size: 0.6rem;
            opacity: 0.9;
            margin-top: 2px;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-top: 1px solid var(--bg-secondary);
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0;
            box-shadow: 0 -2px 12px rgba(0,0,0,0.08);
            z-index: 100;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-light);
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-icon {
            width: 24px;
            height: 24px;
        }

        .nav-label {
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 80px;
            right: 1rem;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--accent) 0%, #d97706 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
            cursor: pointer;
            transition: transform 0.3s;
            z-index: 99;
        }

        .fab:hover {
            transform: scale(1.1);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            padding: 1rem;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            border-radius: 16px;
            padding: 1.5rem;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text);
            font-size: 0.875rem;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--bg-secondary);
            border-radius: 8px;
            font-size: 1rem;
            transition: border 0.3s;
            background: var(--white);
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .modal-footer {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .btn {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: #cbd5e1;
        }

        .btn-license {
            background: var(--license);
            color: var(--white);
        }

        .btn-license:hover {
            background: #0891b2;
        }

        /* Legend */
        .legend {
            display: flex;
            gap: 1rem;
            padding: 0.5rem 1rem;
            background: var(--white);
            border-top: 1px solid var(--bg-secondary);
            font-size: 0.75rem;
            position: fixed;
            bottom: 73px;
            left: 0;
            right: 0;
            z-index: 75;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: linear-gradient(135deg, #10b981 0%, #047857 100%);
            color: var(--white);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
            transform: translateX(500px);
            transition: transform 0.4s ease-in-out;
            z-index: 2000;
            max-width: 320px;
            font-weight: 500;
        }

        .toast.show {
            transform: translateX(0);
        }

        /* Separador de turnos */
        .time-separator {
            background: var(--bg-secondary);
            padding: 0.25rem;
            font-size: 0.6rem;
            color: var(--text-light);
            text-align: center;
            font-weight: 600;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 20px;
            grid-column: 1 / -1;
            margin: 1px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .time-separator:hover {
            background: var(--border);
        }

        .morning-hidden {
            display: none !important;
        }

        /* Attendance Mode */
        .attendance-mode {
            background: var(--accent);
            color: var(--white);
            padding: 0.5rem 1rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        /* CSS para toggle buttons */
        .view-controls {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            padding: 0.5rem 1rem;
            background: var(--white);
            border-bottom: 1px solid var(--bg-secondary);
        }

        .toggle-btn {
            padding: 0.25rem 0.75rem;
            border: 1px solid var(--border);
            background: var(--white);
            color: var(--text-light);
            border-radius: 16px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-btn.active {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }

        .saturday-hidden {
            display: none !important;
        }

        /* CSS para colores de asistencia */
        .class-block.attendance-present {
            background: linear-gradient(135deg, #10b981 0%, #047857 100%);
            color: var(--white);
        }

        .class-block.attendance-absent {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: var(--white);
        }

        .class-block.attendance-license {
            background: linear-gradient(135deg, var(--license) 0%, #0891b2 100%);
            color: var(--white);
            opacity: 0.7;
        }

        /* Sabado Oculto */
        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 1px;
            background: var(--border);
            min-width: 320px;
            width: 100%;
        }

        .schedule-grid:has(.saturday-hidden) {
            grid-template-columns: 60px repeat(6, 1fr);
        }

        /* Seccion Estudiantes */
        .students-section {
            padding: 1rem;
            height: 100%;
            overflow-y: auto;
        }

        .students-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .students-header h2 {
            color: var(--primary);
            font-size: 1.25rem;
        }

        .students-filters {
            display: flex;
            gap: 0.5rem;
        }

        .students-filters select {
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.875rem;
        }

        .students-list {
            display: grid;
            gap: 1rem;
        }

        .student-card {
            background: var(--white);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .student-card:hover {
            transform: translateY(-2px);
        }

        .student-card.inactive {
            opacity: 0.6;
            border: 1px solid var(--error);
        }

        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .student-name {
            font-weight: 600;
            color: var(--primary);
            font-size: 1rem;
        }

        .student-status {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .student-status.active {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .student-status.inactive {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        .student-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-light);
        }

        .student-credits {
            grid-column: 1 / -1;
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: var(--accent);
            font-weight: 500;
        }

        .monthly-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin: 1rem 0;
        }

        .stat-box {
            text-align: center;
            padding: 0.75rem;
            border-radius: 8px;
            background: var(--bg-main);
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-light);
        }

        /* Lista de Recuperaciones */
        .recoveries-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .recovery-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: var(--bg-main);
            border-radius: 8px;
            font-size: 0.875rem;
        }

        .recovery-status {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .recovery-status.present {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .recovery-status.absent {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        .recovery-status.pendiente {
            background: rgba(100, 116, 139, 0.1);
            color: var(--text-light);
        }

        .class-block.attendance-pending {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .attendance-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .btn-present {
            background: var(--success);
            color: var(--white);
        }

        .btn-absent {
            background: var(--error);
            color: var(--white);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-top">
            <h1>CLASES</h1>
            <div class="week-nav">
                <button onclick="changeWeek(-1)">‹</button>
                <span id="currentWeek">Semana Actual</span>
                <button onclick="changeWeek(1)">›</button>
            </div>
        </div>
        <div class="week-days">
            <div class="week-day-header" data-day="1">Lun<br><span id="day1"></span></div>
            <div class="week-day-header" data-day="2">Mar<br><span id="day2"></span></div>
            <div class="week-day-header" data-day="3">Mié<br><span id="day3"></span></div>
            <div class="week-day-header" data-day="4">Jue<br><span id="day4"></span></div>
            <div class="week-day-header" data-day="5">Vie<br><span id="day5"></span></div>
            <div class="week-day-header" data-day="6">Sáb<br><span id="day6"></span></div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="schedule-container">
            <div class="schedule-grid" id="scheduleGrid">
                <!-- Se genera dinámicamente -->
            </div>
        </div>
    </div>

    <!-- Students Section -->
    <div class="students-section" id="studentsSection" style="display: none;">
        <div class="students-header">
            <h2>Alumnos</h2>
            <div class="students-filters">
                <select id="instrumentFilter">
                    <option value="">Todos los instrumentos</option>
                    <option value="Guitarra">Guitarra</option>
                    <option value="Piano">Piano</option>
                    <option value="Violín">Violín</option>
                    <option value="Bajo">Bajo</option>
                    <option value="Batería">Batería</option>
                </select>
                <select id="statusFilter">
                    <option value="">Todos</option>
                    <option value="active">Activos</option>
                    <option value="inactive">Inactivos</option>
                </select>
            </div>
        </div>
        <div class="students-list" id="studentsList">
            <!-- Lista generada dinámicamente -->
        </div>
    </div>

    <!-- Modal Student Form -->
    <div class="modal" id="studentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="studentModalTitle">Agregar Alumno</h2>
            </div>
            <form id="studentForm">
                <div class="form-group">
                    <label class="form-label">Nombre</label>
                    <input type="text" class="form-input" id="studentName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Instrumento</label>
                    <select class="form-select" id="studentInstrument" required>
                        <option value="">Seleccionar...</option>
                        <option value="Guitarra">Guitarra</option>
                        <option value="Piano">Piano</option>
                        <option value="Violín">Violín</option>
                        <option value="Bajo">Bajo</option>
                        <option value="Batería">Batería</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Día de clase</label>
                    <select class="form-select" id="studentDay" required>
                        <option value="">Seleccionar...</option>
                        <option value="1">Lunes</option>
                        <option value="2">Martes</option>
                        <option value="3">Miércoles</option>
                        <option value="4">Jueves</option>
                        <option value="5">Viernes</option>
                        <option value="6">Sábado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Horario</label>
                    <select class="form-select" id="studentTime" required>
                        <option value="">Seleccionar...</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Student Details -->
    <div class="modal" id="studentDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="studentDetailsTitle">Detalles del Alumno</h2>
            </div>
            <div id="studentDetailsBody">
                <!-- Contenido dinámico -->
            </div>
            <div class="modal-footer" id="studentDetailsFooter">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal Deactivate Student -->
    <div class="modal" id="deactivateModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Desactivar Alumno</h2>
            </div>
            <form id="deactivateForm">
                <p id="deactivateStudentName"></p>
                <div class="form-group">
                    <label class="form-label">Fecha desde cuándo cancela clases</label>
                    <input type="date" class="form-input" id="deactivateDate" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                    <button type="submit" class="btn btn-absent">Desactivar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Legend -->
    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background: var(--primary)"></div>
            <span>Regular</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: var(--recovery)"></div>
            <span>Recuperación</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: var(--license)"></div>
            <span>Licencia</span>
        </div>
    </div>

    <!-- Floating Action Button -->
    <div class="fab" onclick="openAttendanceMode()">
        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="3">
            <path d="M9 11l3 3L22 4"/>
        </svg>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('calendar')">
            <svg class="nav-icon" fill="currentColor" viewBox="0 0 24 24">
                <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
            </svg>
            <span class="nav-label">Calendario</span>
        </div>
        <div class="nav-item" onclick="switchTab('students')">
            <svg class="nav-icon" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
            <span class="nav-label">Alumnos</span>
        </div>
        <div class="nav-item" onclick="switchTab('finance')">
            <svg class="nav-icon" fill="currentColor" viewBox="0 0 24 24">
                <path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/>
            </svg>
            <span class="nav-label">Finanzas</span>
        </div>
        <div class="nav-item" onclick="switchTab('settings')">
            <svg class="nav-icon" fill="currentColor" viewBox="0 0 24 24">
                <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
            </svg>
            <span class="nav-label">Ajustes</span>
        </div>
    </div>

    <!-- Modal Clase Details -->
    <div class="modal" id="classModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Detalles de Clase</h2>
            </div>
            <div id="modalBody">
                <!-- Contenido dinámico -->
            </div>
            <div class="modal-footer" id="modalFooter">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal Recovery Class -->
    <div class="modal" id="recoveryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Agendar Recuperación</h2>
            </div>
            <form id="recoveryForm">
                <div class="form-group">
                    <label class="form-label">Alumno (con créditos disponibles)</label>
                    <select class="form-select" id="recoveryStudent" required>
                        <option value="">Seleccionar alumno...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Fecha y Hora</label>
                    <input type="text" class="form-input" id="recoveryDateTime" readonly>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Agendar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // Estado de la aplicación
        let currentWeek = new Date();
        let students = [];
        let regularClasses = [];
        let specialClasses = []; // Recuperaciones y licencias
        let attendance = [];
        let attendanceMode = false;
        let showMorning = false;
        let showSaturday = false;

        // Configuración de horarios
        const schedule = {
            morning: {
                start: '08:30',
                end: '12:15',
                days: [1,2,3,4,5,6] // L-S
            },
            afternoon: {
                regularEnd: {
                    default: '19:45', // L-J
                    friday: '17:30',  // V
                    saturday: null    // S no hay tarde regular
                },
                recoveryEnd: {
                    friday: '19:45',   // V recuperación
                    saturday: '13:00'  // S recuperación
                },
                start: '14:30',
                days: [1,2,3,4,5] // L-V
            }
        };

        // Generar slots de tiempo
        const timeSlots = [
            '08:30', '09:15', '10:00', '10:45', '11:30',
            '14:30', '15:15', '16:00', '16:45', '17:30', '18:15', '19:00'
        ];

        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
            renderWeekView();
            setupEventListeners();
        });

        function initApp() {
            // Cargar datos del localStorage
            students = JSON.parse(localStorage.getItem('students') || '[]');
            regularClasses = JSON.parse(localStorage.getItem('regularClasses') || '[]');
            specialClasses = JSON.parse(localStorage.getItem('specialClasses') || '[]');
            attendance = JSON.parse(localStorage.getItem('attendance') || '[]');
        }

        function saveData() {
            localStorage.setItem('students', JSON.stringify(students));
            localStorage.setItem('regularClasses', JSON.stringify(regularClasses));
            localStorage.setItem('specialClasses', JSON.stringify(specialClasses));
            localStorage.setItem('attendance', JSON.stringify(attendance));
        }

        function renderWeekView() {
            const startOfWeek = getStartOfWeek(currentWeek);
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(endOfWeek.getDate() + 5); // Solo hasta viernes

            const weekText = `${formatDate(startOfWeek)} - ${formatDate(endOfWeek)}`;
            document.getElementById('currentWeek').textContent = weekText;

            // Actualizar días (sin domingo)
            for (let i = 0; i < 6; i++) {
                const date = new Date(startOfWeek);
                date.setDate(date.getDate() + i);
                const dayNum = i + 1;
                document.getElementById(`day${dayNum}`).textContent = date.getDate();
                
                const header = document.querySelector(`.week-day-header[data-day="${dayNum}"]`);
                if (isToday(date)) {
                    header.classList.add('today');
                } else {
                    header.classList.remove('today');
                }
            }

            renderScheduleGrid(startOfWeek);
        }

        function renderScheduleGrid(startOfWeek) {
            const grid = document.getElementById('scheduleGrid');
            grid.innerHTML = '';
            
            const morningSlots = ['08:30', '09:15', '10:00', '10:45', '11:30'];
            const afternoonSlots = ['14:30', '15:15', '16:00', '16:45', '17:30', '18:15', '19:00'];
            
            const currentSlots = hideMorning ? afternoonSlots : [...morningSlots, ...afternoonSlots];

            currentSlots.forEach((time, index) => {
                // Separadores de mañana/tarde
                if (!hideMorning && index === 5) {
                    const separator = document.createElement('div');
                    separator.className = 'time-separator';
                    separator.textContent = '▲ Ocultar mañana';
                    separator.style.gridColumn = '1 / -1';
                    separator.onclick = toggleMorningView;
                    grid.appendChild(separator);
                }
                
                if (hideMorning && index === 0) {
                    const separator = document.createElement('div');
                    separator.className = 'time-separator';
                    separator.textContent = '▼ Mostrar mañana';
                    separator.style.gridColumn = '1 / -1';
                    separator.onclick = toggleMorningView;
                    grid.appendChild(separator);
                }

                // Slots para días L-S
                for (let i = 0; i < 6; i++) {
                    const date = new Date(startOfWeek);
                    date.setDate(date.getDate() + i);
                    const dayNum = i + 1;
                    
                    const slot = document.createElement('div');
                    slot.className = 'slot';
                    
                    // PRIORIDAD 1: Recuperaciones (tienen prioridad sobre todo)
                    const specialClasses = findSpecialClass(date, time);
                    const recovery = specialClasses?.type === 'recovery' ? specialClasses : null;
                    const license = specialClasses?.type === 'license' ? specialClasses : null;
                    
                    if (recovery) {
                        // Si hay recuperación, mostrarla con prioridad
                        renderClass(slot, recovery, 'special');
                    } 
                    // PRIORIDAD 2: Clases regulares (si no hay recuperación)
                    else {
                        const regularClass = findRegularClass(dayNum, time);
                        if (regularClass && !license) {
                            // Mostrar clase regular solo si no hay licencia
                            renderClass(slot, regularClass, 'regular');
                        } 
                        // PRIORIDAD 3: Licencias (si no hay recuperación ni clase regular)
                        else if (license) {
                            renderClass(slot, license, 'special');
                        } 
                        // PRIORIDAD 4: Slot vacío
                        else {
                            slot.classList.add('empty');
                            slot.textContent = time;
                            slot.onclick = () => {
                                const slotDate = new Date(startOfWeek);
                                slotDate.setDate(slotDate.getDate() + i);
                                handleSlotClick(slotDate, time, dayNum);
                            };
                        }
                    }

                    grid.appendChild(slot);
                }
            });
        }

        function isSlotAvailable(day, time, isRecovery) {
            const hour = parseInt(time.split(':')[0]);
            const minutes = parseInt(time.split(':')[1]);
            const timeValue = hour * 60 + minutes;

            // Domingo no disponible
            if (day === 0) return false;

            // Horario mañana (L-S)
            if (timeValue >= 8*60+30 && timeValue < 12*60+15) {
                if (day >= 1 && day <= 6) {
                    if (isRecovery && day === 6 && timeValue >= 12*60+15) {
                        return timeValue < 13*60; // Sábado recuperación hasta 1pm
                    }
                    return true;
                }
            }

            // Horario tarde
            if (timeValue >= 14*60+30) {
                // Sábado tarde solo recuperación hasta 1pm (ya manejado arriba)
                if (day === 6) return false;
                
                // Viernes
                if (day === 5) {
                    if (isRecovery) {
                        return timeValue < 19*60+45;
                    } else {
                        return timeValue < 17*60+30;
                    }
                }
                
                // Lunes a Jueves
                if (day >= 1 && day <= 4) {
                    return timeValue < 19*60+45;
                }
            }

            return false;
        }

        function findRegularClass(day, time) {
            const weekStartDate = getStartOfWeek(currentWeek);
            const classDate = getClassDateInWeek(day, weekStartDate);
            
            // Si hay cualquier special class, no mostrar clase regular
            const specialClass = findSpecialClass(classDate, time);
            if (specialClass) {
                return null;
            }

            // Si hay licencia, no mostrar clase regular
            if (specialClass && specialClass.type === 'recovery') {
                return null;
            }
            
            const student = students.find(s => 
                s.regularDay === day && 
                s.regularTime === time &&
                isStudentActiveOnDate(s, classDate)
            );
            
            if (student) {
                let regularClass = regularClasses.find(rc => rc.studentId === student.id);
                
                if (!regularClass) {
                    regularClass = {
                        id: Date.now() + Math.random(),
                        studentId: student.id,
                        day: student.regularDay,
                        time: student.regularTime
                    };
                    regularClasses.push(regularClass);
                    saveData();
                }
                
                return { 
                    ...regularClass,
                    studentName: student.name
                };
            }
            
            return null;
        }

        function findSpecialClass(date, time) {
            const dateStr = date.toISOString().split('T')[0];
            const specials = specialClasses.filter(c => c.date === dateStr && c.time === time);
            
            if (specials.length === 0) return null;
            
            // Buscar recuperación primero (tiene prioridad visual)
            const recovery = specials.find(c => c.type === 'recovery');
            if (recovery) {
                const student = students.find(s => s.id === recovery.studentId);
                return { ...recovery, studentName: student?.name || 'Desconocido' };
            }
            
            // Si no hay recuperación, retornar licencia
            const license = specials.find(c => c.type === 'license');
            if (license) {
                const student = students.find(s => s.id === license.studentId);
                return { ...license, studentName: student?.name || 'Desconocido' };
            }
            
            return null;
        }

        function renderClass(slot, classData, type) {
            const block = document.createElement('div');
            block.className = 'class-block';

            if (type === 'special') {
                block.classList.add(classData.type);
            } else {
                block.classList.add('regular');
                
                const attendanceStatus = getAttendanceStatus(classData, getStartOfWeek(currentWeek));
                if (attendanceStatus) {
                    block.classList.add(`attendance-${attendanceStatus}`);
                }
            }

            if (attendanceMode && !hasAttendance(classData)) {
                block.classList.add('attendance-pending');
            }

            block.innerHTML = `
                <div class="class-name">${classData.studentName}</div>
                ${type === 'special' ? `<div class="class-type">${classData.type === 'recovery' ? 'Recuperación' : 'Licencia'}</div>` : ''}
            `;

            // Click para recuperaciones - mostrar detalles y asistencia
            if (type === 'special' && classData.type === 'recovery') {
                block.onclick = (e) => {
                    e.stopPropagation();
                    showClassDetails(classData, type);
                };
                block.style.cursor = 'pointer';
            }
            // Click para licencias - abrir modal de recuperación
            else if (type === 'special' && classData.type === 'license') {
                block.onclick = (e) => {
                    e.stopPropagation();
                    
                    const studentsWithCredits = students.filter(s => s.licenseCredits > 0);
                    
                    if (studentsWithCredits.length === 0) {
                        showToast('No hay alumnos con créditos de recuperación disponibles');
                        return;
                    }
                    
                    const date = new Date(classData.date);
                    openRecoveryModal(date, classData.time, studentsWithCredits);
                };
                
                block.style.cursor = 'pointer';
                block.title = 'Click para programar recuperación';
            } 
            // Click para clases regulares
            else {
                block.onclick = (e) => {
                    e.stopPropagation();
                    showClassDetails(classData, type);
                };
            }

            slot.appendChild(block);
        }

        function handleSlotClick(date, time, day) {
            const studentsWithCredits = students.filter(s => s.licenseCredits > 0);
            
            if (studentsWithCredits.length === 0) {
                showToast('No hay alumnos con créditos de recuperación disponibles');
                return;
            }

            openRecoveryModal(date, time, studentsWithCredits);
        }

        function openRecoveryModal(date, time, eligibleStudents) {
            const modal = document.getElementById('recoveryModal');
            const select = document.getElementById('recoveryStudent');
            const dateTimeInput = document.getElementById('recoveryDateTime');

            const dateStr = date.toISOString().split('T')[0];
            dateTimeInput.value = `${formatDate(date)} - ${time}`;
            dateTimeInput.dataset.date = dateStr;
            dateTimeInput.dataset.time = time;
            
            // LIMPIAR MENSAJES ANTERIORES
            const modalContent = modal.querySelector('.modal-content');
            const existingInfo = modalContent.querySelector('.conflict-info');
            if (existingInfo) existingInfo.remove();

            // Verificar conflictos
            const conflicts = findAllConflictsAt(date, time);

            // Si hay recuperaciones, mostrar opción de eliminar
            if (conflicts.recoveries.length > 0) {
                const conflictInfo = document.createElement('div');
                conflictInfo.style.cssText = 'background: rgba(239, 68, 68, 0.1); padding: 0.75rem; border-radius: 8px; margin: 1rem 0; font-size: 0.875rem;';
                conflictInfo.innerHTML = `
                    <p><strong>❌ Ya hay recuperaciones en este horario:</strong></p>
                    ${conflicts.recoveries.map(r => `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin: 0.5rem 0;">
                            <span>• ${r.studentName}</span>
                            <button onclick="deleteRecovery(${r.id}); closeModal();" style="background: #ef4444; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer;">
                                Eliminar
                            </button>
                        </div>
                    `).join('')}
                `;
                conflictInfo.className = 'conflict-info';
                modalContent.insertBefore(conflictInfo, modalContent.lastElementChild);
                
                // Deshabilitar el formulario
                select.disabled = true;
                document.querySelector('#recoveryForm button[type="submit"]').disabled = true;
            } else {
                // Habilitar el formulario
                select.disabled = false;
                document.querySelector('#recoveryForm button[type="submit"]').disabled = false;
                
                // Mostrar licencias y clases regulares como información contextual
                const allConflicts = [
                    ...conflicts.licenses.map(l => ({ 
                        name: l.studentName, 
                        type: l.autoGenerated ? 'Licencia automática' : 'Licencia' 
                    })),
                    ...conflicts.regularClasses.map(r => ({ name: r.studentName, type: 'Clase regular' }))
                ];
                
                if (allConflicts.length > 0) {
                    const conflictInfo = document.createElement('div');
                    conflictInfo.style.cssText = 'background: rgba(245, 158, 11, 0.1); padding: 0.75rem; border-radius: 8px; margin: 1rem 0; font-size: 0.875rem;';
                    conflictInfo.innerHTML = `
                        <p><strong>ℹ️ Este horario también tiene:</strong></p>
                        ${allConflicts.map(c => `<p>• ${c.name} (${c.type})</p>`).join('')}
                        <p><small>La recuperación tendrá prioridad visual</small></p>
                    `;
                    conflictInfo.className = 'conflict-info';
                    modalContent.insertBefore(conflictInfo, modalContent.lastElementChild);
                }
            }

            // Poblar select
            select.innerHTML = '<option value="">Seleccionar alumno...</option>';
            eligibleStudents.forEach(student => {
                select.innerHTML += `<option value="${student.id}">${student.name} (${student.licenseCredits} créditos)</option>`;
            });

            modal.classList.add('active');
        }

        function showClassDetails(classData, type) {
            const modal = document.getElementById('classModal');
            const modalBody = document.getElementById('modalBody');
            const modalFooter = document.getElementById('modalFooter');

            // Limpiar modal anterior
            modalBody.innerHTML = '';
            modalFooter.innerHTML = '';

            if (type === 'regular') {
                const weekStart = getStartOfWeek(currentWeek);
                const classDate = new Date(weekStart);
                classDate.setDate(classDate.getDate() + ((classData.day + 6) % 7));
                const dateStr = classDate.toISOString().split('T')[0];
                
                const attendanceRecord = attendance.find(a => a.classId === classData.id && a.date === dateStr);
                const conflicts = findAllConflictsAt(classDate, classData.time);
                const conflictingRecoveries = conflicts.recoveries.filter(r => r.studentId !== classData.studentId);
                
                modalBody.innerHTML = `
                    <p><strong>Alumno:</strong> ${classData.studentName}</p>
                    <p><strong>Horario:</strong> ${getDayName(classData.day)} ${classData.time}</p>
                    <p><strong>Fecha:</strong> ${dateStr}</p>
                    ${attendanceRecord ? `<p><strong>Estado actual:</strong> ${getStatusText(attendanceRecord.status)}</p>` : ''}
                    
                    ${conflictingRecoveries.length > 0 ? `
                        <div style="background: rgba(139, 92, 246, 0.1); padding: 0.75rem; border-radius: 8px; margin: 0.5rem 0;">
                            <p><strong>⚠️ Conflicto detectado:</strong></p>
                            ${conflictingRecoveries.map(recovery => 
                                `<p>Recuperación de <strong>${recovery.studentName}</strong> en mismo horario</p>`
                            ).join('')}
                            <p><small>La recuperación tiene prioridad visual en calendario</small></p>
                        </div>
                    ` : ''}
                    
                    ${attendanceMode ? `
                        <div class="attendance-buttons">
                            <button class="btn btn-present" onclick="markAttendanceWithDate(${classData.id}, 'present', '${dateStr}')">Presente</button>
                            <button class="btn btn-absent" onclick="markAttendanceWithDate(${classData.id}, 'absent', '${dateStr}')">Ausente</button>
                            <button class="btn btn-license" onclick="markAttendanceWithDate(${classData.id}, 'license', '${dateStr}')">Licencia</button>
                        </div>
                    ` : ''}
                `;
                
                // Footer SOLO para clases regulares
                modalFooter.innerHTML = `<button type="button" class="btn btn-secondary" onclick="closeModal()">Cerrar</button>`;
                
            } else if (type === 'special' && classData.type === 'recovery') {
                const attendanceRecord = attendance.find(a => 
                    a.classId === classData.id && a.date === classData.date
                );
                
                const conflicts = findAllConflictsAt(classData.date, classData.time);
                const otherConflicts = [
                    ...conflicts.regularClasses.filter(r => r.studentId !== classData.studentId),
                    ...conflicts.licenses.filter(l => l.studentId !== classData.studentId)
                ];
                
                modalBody.innerHTML = `
                    <p><strong>Alumno:</strong> ${classData.studentName}</p>
                    <p><strong>Fecha:</strong> ${classData.date}</p>
                    <p><strong>Hora:</strong> ${classData.time}</p>
                    <p><strong>Tipo:</strong> Recuperación</p>
                    ${attendanceRecord ? `<p><strong>Estado:</strong> ${getStatusText(attendanceRecord.status)}</p>` : ''}
                    
                    ${otherConflicts.length > 0 ? `
                        <div style="background: rgba(245, 158, 11, 0.1); padding: 0.75rem; border-radius: 8px; margin: 0.5rem 0;">
                            <p><strong>ℹ️ Este horario también tiene:</strong></p>
                            ${otherConflicts.map(item => {
                                const isLicense = conflicts.licenses.some(l => l.studentId === item.studentId);
                                const type = isLicense ? 
                                    (item.autoGenerated ? 'Licencia automática' : 'Licencia') : 
                                    'Clase regular';
                                return `<p>• ${item.studentName} (${type})</p>`;
                            }).join('')}
                        </div>
                    ` : ''}
                    
                    ${attendanceMode ? `
                        <div class="attendance-buttons">
                            <button class="btn btn-present" onclick="markRecoveryAttendance(${classData.id}, 'present', '${classData.date}')">Presente</button>
                            <button class="btn btn-absent" onclick="markRecoveryAttendance(${classData.id}, 'absent', '${classData.date}')">Ausente</button>
                        </div>
                    ` : ''}
                `;
                
                modalFooter.innerHTML = `
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cerrar</button>
                    <button type="button" class="btn" style="background: #ef4444; color: white;" onclick="deleteRecovery(${classData.id})">🗑️ Eliminar</button>
                `;
            } else {
                // Licencias - solo detalles
                const conflicts = findAllConflictsAt(classData.date, classData.time);
                const conflictingRecoveries = conflicts.recoveries.filter(r => r.studentId !== classData.studentId);
                const conflictingRegulars = conflicts.regularClasses.filter(r => r.studentId !== classData.studentId);
                
                modalBody.innerHTML = `
                    <p><strong>Alumno:</strong> ${classData.studentName}</p>
                    <p><strong>Fecha:</strong> ${classData.date}</p>
                    <p><strong>Hora:</strong> ${classData.time}</p>
                    <p><strong>Tipo:</strong> ${classData.autoGenerated ? `Licencia automática (${classData.reason || 'Inscripción tardía'})` : 'Licencia manual'}</p>
                    
                    ${conflictingRecoveries.length > 0 ? `
                        <div style="background: rgba(139, 92, 246, 0.1); padding: 0.75rem; border-radius: 8px; margin: 0.5rem 0;">
                            <p><strong>ℹ️ Recuperación en este horario:</strong></p>
                            ${conflictingRecoveries.map(recovery => 
                                `<p><strong>${recovery.studentName}</strong> tiene recuperación programada</p>`
                            ).join('')}
                        </div>
                    ` : ''}
                    
                    ${conflictingRegulars.length > 0 ? `
                        <div style="background: rgba(245, 158, 11, 0.1); padding: 0.75rem; border-radius: 8px; margin: 0.5rem 0;">
                            <p><strong>ℹ️ Clase regular en este horario:</strong></p>
                            ${conflictingRegulars.map(regular => 
                                `<p><strong>${regular.studentName}</strong> tiene clase regular programada</p>`
                            ).join('')}
                        </div>
                    ` : ''}
                    
                    <div style="background: rgba(245, 158, 11, 0.1); padding: 0.75rem; border-radius: 8px; margin: 0.5rem 0;">
                        <p><strong>💡 Tip:</strong> Click en la licencia del calendario para programar una recuperación en este horario</p>
                    </div>
                `;
                
                // Footer SOLO para licencias (sin eliminar)
                modalFooter.innerHTML = `<button type="button" class="btn btn-secondary" onclick="closeModal()">Cerrar</button>`;
            }

            modal.classList.add('active');
        }

        // DEBUG: Función para verificar conflictos
        function debugConflicts(date, time) {
            console.log('=== DEBUG CONFLICTOS ===');
            console.log('Fecha:', date, 'Hora:', time);
            
            const recoveries = specialClasses.filter(sc => 
                sc.type === 'recovery' && 
                sc.date === date && 
                sc.time === time
            );
            console.log('Recuperaciones:', recoveries);
            
            const [year, month, day] = dateStr.split('-').map(Number);
            const dateObj = new Date(year, month - 1, day);
            const dayOfWeek = dateObj.getDay();
            const systemDay = getSystemDayFromDateDay(dayOfWeek);
            
            const regulars = students.filter(s => 
                s.regularTime === time && 
                s.regularDay === systemDay &&
                isStudentActiveOnDate(s, dateObj)
            );
            console.log('Clases regulares:', regulars);
        }

        function debugAllConflicts() {
            console.log('=== DEBUG TODOS LOS CONFLICTOS ===');
            
            // Verificar todas las fechas con recuperaciones
            const recoveryDates = [...new Set(specialClasses
                .filter(sc => sc.type === 'recovery')
                .map(sc => sc.date))];
            
            recoveryDates.forEach(date => {
                const dayConflicts = findAllConflictsAt(date, '16:00'); // ejemplo
                console.log(`${date}:`, dayConflicts);
            });
        }

        function findAllConflictsAt(date, time) {
            const dateStr = typeof date === 'string' ? date : date.toISOString().split('T')[0];
            
            const [year, month, day] = dateStr.split('-').map(Number);
            const dateObj = new Date(year, month - 1, day);
            const dayOfWeek = dateObj.getDay();
            
            const conflicts = {
                recoveries: [],
                regularClasses: [],
                licenses: []
            };
            
            // Buscar recuperaciones
            const recoveries = specialClasses.filter(sc => 
                sc.type === 'recovery' && 
                sc.date === dateStr && 
                sc.time === time
            );
            
            recoveries.forEach(recovery => {
                const student = students.find(s => s.id === recovery.studentId);
                if (student) {
                    conflicts.recoveries.push({
                        ...recovery,
                        studentName: student.name,
                        studentId: recovery.studentId
                    });
                }
            });
            
            // Buscar licencias
            const licenses = specialClasses.filter(sc => 
                sc.type === 'license' && 
                sc.date === dateStr && 
                sc.time === time
            );
            
            const studentsWithLicense = new Set();
            licenses.forEach(license => {
                const student = students.find(s => s.id === license.studentId);
                if (student) {
                    studentsWithLicense.add(license.studentId);
                    conflicts.licenses.push({
                        ...license,
                        studentName: student.name,
                        studentId: license.studentId
                    });
                }
            });
            
            // Buscar clases regulares SOLO si NO tienen licencia
            if (dayOfWeek !== 0) {
                const systemDay = dayOfWeek;
                
                const regularStudents = students.filter(s => 
                    s.regularDay === systemDay && 
                    s.regularTime === time &&
                    isStudentActiveOnDate(s, dateObj) &&
                    !studentsWithLicense.has(s.id) // NO incluir si ya tiene licencia
                );
                
                regularStudents.forEach(student => {
                    const regularClass = regularClasses.find(rc => rc.studentId === student.id);
                    if (regularClass) {
                        conflicts.regularClasses.push({
                            ...regularClass,
                            studentName: student.name,
                            studentId: student.id
                        });
                    }
                });
            }
            
            return conflicts;
        }

        // NUEVA: Función debug específica para un caso
        function debugSpecificConflict(dateStr, time) {
            console.log('=== DEBUG CASO ESPECÍFICO ===');
            console.log(`Fecha: ${dateStr}, Hora: ${time}`);
            
            const [year, month, day] = dateStr.split('-').map(Number);
            const dateObj = new Date(year, month - 1, day);
            const dayOfWeek = dateObj.getDay();
            console.log(`Día de la semana: ${dayOfWeek} (0=Dom, 1=Lun, 2=Mar, 3=Mié, 4=Jue, 5=Vie, 6=Sáb)`);
            
            console.log('\n--- TODOS LOS ESTUDIANTES ---');
            students.forEach(s => {
                console.log(`${s.name}: regularDay=${s.regularDay}, regularTime=${s.regularTime}, active=${s.active}, startDate=${s.startDate}, deactivatedAt=${s.deactivatedAt}`);
                console.log(`  ¿Activo en ${dateStr}? ${isStudentActiveOnDate(s, dateObj)}`);
            });
            
            console.log('\n--- RECUPERACIONES EN ESTA FECHA/HORA ---');
            const recoveries = specialClasses.filter(sc => 
                sc.type === 'recovery' && sc.date === dateStr && sc.time === time
            );
            console.log(recoveries);
            
            console.log('\n--- LICENCIAS EN ESTA FECHA/HORA ---');
            const licenses = specialClasses.filter(sc => 
                sc.type === 'license' && sc.date === dateStr && sc.time === time
            );
            console.log(licenses);
            
            return findAllConflictsAt(dateStr, time);
        }


        function deleteRecovery(recoveryId) {
            const recovery = specialClasses.find(c => c.id === recoveryId);
            if (recovery && recovery.type === 'recovery') {
                // Eliminar recuperación
                specialClasses = specialClasses.filter(c => c.id !== recoveryId);
                
                // Restaurar crédito al estudiante
                const student = students.find(s => s.id === recovery.studentId);
                if (student) {
                    student.licenseCredits = (student.licenseCredits || 0) + 1;
                }
                
                // Eliminar asistencias relacionadas
                attendance = attendance.filter(a => a.classId !== recoveryId);
                
                saveData();
                renderWeekView();
                closeModal();
                showToast('Recuperación eliminada. Crédito restaurado.');
            }
        }

        function markAttendanceWithDate(classId, status, date) {
            const classData = regularClasses.find(c => c.id === classId);
            
            // Remover asistencia anterior del mismo día
            attendance = attendance.filter(a => !(a.classId === classId && a.date === date));
            
            // Agregar nueva asistencia
            attendance.push({
                classId,
                date,
                status,
                timestamp: Date.now()
            });

            if (status === 'license') {
                markAsLicense(classId);
            } else {
                saveData();
                renderWeekView();
                closeModal();
                showToast(`Asistencia actualizada: ${getStatusText(status)}`);
            }
        }

        function markRecoveryAttendance(classId, status, date) {
            // Remover asistencia anterior
            attendance = attendance.filter(a => !(a.classId === classId && a.date === date));
            
            // Agregar nueva asistencia
            attendance.push({
                classId,
                date,
                status,
                timestamp: Date.now()
            });

            saveData();
            renderWeekView();
            closeModal();
            showToast(`Recuperación marcada: ${getStatusText(status)}`);
        }

        function getStatusText(status) {
            const texts = { present: 'Presente', absent: 'Ausente', license: 'Licencia' };
            return texts[status] || status;
        }

        function markAsLicense(classId) {
            const regularClass = regularClasses.find(c => c.id === classId);
            if (regularClass) {
                // Crear entrada de licencia
                const today = new Date();
                const weekStart = getStartOfWeek(currentWeek);
                const classDate = new Date(weekStart);
                classDate.setDate(classDate.getDate() + ((regularClass.day + 6) % 7));

                specialClasses.push({
                    id: Date.now(),
                    studentId: regularClass.studentId,
                    date: classDate.toISOString().split('T')[0],
                    time: regularClass.time,
                    type: 'license',
                    originalClassId: classId
                });

                // Agregar crédito al estudiante
                const student = students.find(s => s.id === regularClass.studentId);
                if (student) {
                    student.licenseCredits = (student.licenseCredits || 0) + 1;
                }

                saveData();
                renderWeekView();
                closeModal();
                showToast('Licencia registrada. Crédito de recuperación agregado.');
            }
        }

        function markAttendance(classId, status) {
            const today = new Date().toISOString().split('T')[0];
            const classData = regularClasses.find(c => c.id === classId);
            
            // Si cambia de licencia a otra cosa, validar balance
            const currentRecord = attendance.find(a => a.classId === classId && a.date === today);
            if (currentRecord?.status === 'license' && status !== 'license') {
                showLicenseWarning(classData.studentId);
            }
            
            attendance = attendance.filter(a => !(a.classId === classId && a.date === today));
            
            attendance.push({
                classId,
                date: today,
                status,
                timestamp: Date.now()
            });

            if (status === 'license') {
                markAsLicense(classId);
            } else {
                saveData();
                renderWeekView();
                closeModal();
                showToast(`Asistencia actualizada: ${getStatusText(status)}`);
            }
        }

        function hasAttendance(classData) {
            const today = new Date().toISOString().split('T')[0];
            return attendance.some(a => a.classId === classData.id && a.date === today);
        }

        function openAttendanceMode() {
            attendanceMode = !attendanceMode;
            if (attendanceMode) {
                showToast('Modo asistencia activado. Toca las clases para marcar asistencia.');
                document.querySelector('.fab').style.background = 'var(--success)';
            } else {
                showToast('Modo asistencia desactivado');
                document.querySelector('.fab').style.background = 'linear-gradient(135deg, var(--accent) 0%, #d97706 100%)';
            }
            renderWeekView();
        }

        function setupEventListeners() {
            document.getElementById('recoveryForm').addEventListener('submit', (e) => {
                e.preventDefault();
                saveRecoveryClass();
            });

            document.getElementById('studentForm').addEventListener('submit', (e) => {
                e.preventDefault();
                saveStudent();
            });

            // Validación en tiempo real (NUEVO)
            setupScheduleValidation();

            // Cerrar modales al hacer click fuera
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal();
                    }
                });
            });
        }

        // LIMPIAR: Reset variables al cerrar modal
        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
                
                // Limpiar mensajes de conflicto
                const conflictInfo = modal.querySelector('.conflict-info');
                if (conflictInfo) {
                    conflictInfo.remove();
                }
                
                // Resetear formularios
                const form = modal.querySelector('form');
                if (form) {
                    form.reset();
                }
                
                // Habilitar campos que pudieron ser deshabilitados
                const selects = modal.querySelectorAll('select:disabled');
                const buttons = modal.querySelectorAll('button:disabled');
                selects.forEach(s => s.disabled = false);
                buttons.forEach(b => b.disabled = false);
            });
            
            // Reset variables globales
            currentEditingStudent = null;
            
            // Reset estilos de validación
            const timeSelect = document.getElementById('studentTime');
            if (timeSelect) {
                timeSelect.style.borderColor = '';
            }
        }

        function saveRecoveryClass() {
            const studentId = parseInt(document.getElementById('recoveryStudent').value);
            const dateTimeInput = document.getElementById('recoveryDateTime');
            const date = dateTimeInput.dataset.date;
            const time = dateTimeInput.dataset.time;

            if (!studentId) return;

            // Crear clase de recuperación
            specialClasses.push({
                id: Date.now(),
                studentId,
                date,
                time,
                type: 'recovery'
            });

            // Reducir créditos del estudiante
            const student = students.find(s => s.id === studentId);
            if (student) {
                student.licenseCredits--;
            }

            saveData();
            renderWeekView();
            closeModal();
            showToast('Clase de recuperación agendada');
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
        }

        function changeWeek(direction) {
            currentWeek.setDate(currentWeek.getDate() + (direction * 7));
            renderWeekView();
        }

        function switchTab(tab) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            showToast(`Sección ${tab} en desarrollo`);
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Funciones auxiliares
        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Lunes como inicio
            return new Date(d.setDate(diff));
        }

        function formatDate(date) {
            const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            return `${date.getDate()} ${months[date.getMonth()]}`;
        }

        function getDayName(day) {
            const days = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
            return days[day];
        }

        function isToday(date) {
            const today = new Date();
            return date.getDate() === today.getDate() &&
                   date.getMonth() === today.getMonth() &&
                   date.getFullYear() === today.getFullYear();
        }

        function detectMorningClasses() {
            const morningTimes = ['08:30', '09:15', '10:00', '10:45', '11:30'];
            return regularClasses.some(cls => 
                cls.day >= 1 && cls.day <= 5 && morningTimes.includes(cls.time)
            ) || specialClasses.some(cls => {
                const date = new Date(cls.date);
                const day = date.getDay();
                return day >= 1 && day <= 5 && morningTimes.includes(cls.time);
            });
        }

        function getDynamicTimeSlots() {
            const afternoonSlots = ['14:30', '15:15', '16:00', '16:45', '17:30', '18:15', '19:00'];
            const morningSlots = ['08:30', '09:15', '10:00', '10:45', '11:30'];
            
            if (showMorning || detectMorningClasses()) {
                return [...morningSlots, ...afternoonSlots];
            }
            return afternoonSlots;
        }

        let hideMorning = false;

        function toggleMorningView() {
            hideMorning = !hideMorning;
            renderScheduleGrid(getStartOfWeek(currentWeek));
        }

        function toggleMorning() {
            showMorning = !showMorning;
            updateToggleStates();
            renderWeekView();
        }

        function toggleSaturday() {
            showSaturday = !showSaturday;
            updateToggleStates();
            renderWeekView();
        }

        function updateToggleStates() {
            const morningBtn = document.getElementById('morningToggle');
            const saturdayBtn = document.getElementById('saturdayToggle');
            
            if (showMorning || detectMorningClasses()) {
                morningBtn.classList.add('active');
            } else {
                morningBtn.classList.remove('active');
            }
            
            if (showSaturday) {
                saturdayBtn.classList.add('active');
            } else {
                saturdayBtn.classList.remove('active');
            }
        }

        function validateLicenseBalance(studentId) {
            const student = students.find(s => s.id === studentId);
            const studentRecoveries = specialClasses.filter(c => 
                c.studentId === studentId && c.type === 'recovery'
            );
            const studentLicenses = specialClasses.filter(c => 
                c.studentId === studentId && c.type === 'license'
            );
            
            return {
                credits: student?.licenseCredits || 0,
                recoveries: studentRecoveries.length,
                licenses: studentLicenses.length,
                isBalanced: (studentLicenses.length + (student?.licenseCredits || 0)) >= studentRecoveries.length
            };
        }

        function showLicenseWarning(studentId) {
            const balance = validateLicenseBalance(studentId);
            if (!balance.isBalanced) {
                showToast(`⚠️ Alumno tiene ${balance.recoveries} recuperaciones pero solo ${balance.licenses} licencias. Revisa y elimina recuperaciones incorrectas.`);
            }
        }

        function getAttendanceStatus(classData, weekDate) {
            if (classData.day) { // Clase regular
                const classDate = new Date(weekDate);
                classDate.setDate(classDate.getDate() + ((classData.day + 6) % 7));
                const dateStr = classDate.toISOString().split('T')[0];
                const attendanceRecord = attendance.find(a => a.classId === classData.id && a.date === dateStr);
                return attendanceRecord?.status || null;
            } else { // Clase especial
                const attendanceRecord = attendance.find(a => a.classId === classData.id && a.date === classData.date);
                return attendanceRecord?.status || null;
            }
        }

        // JAVASCRIPT SECCION ALUMNOS - Students ********************************************************************************
        let currentEditingStudent = null;

        // Navegación
        function switchTab(tab) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // Ocultar todas las secciones
            document.querySelector('.main-content').style.display = tab === 'calendar' ? 'block' : 'none';
            document.getElementById('studentsSection').style.display = tab === 'students' ? 'block' : 'none';
            
            if (tab === 'students') {
                renderStudentsList();
                populateTimeSlots();
            } else if (tab !== 'calendar') {
                showToast(`Sección ${tab} en desarrollo`);
            }
        }

        // Renderizar lista
        function renderStudentsList() {
            const container = document.getElementById('studentsList');
            const instrumentFilter = document.getElementById('instrumentFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            let filteredStudents = students.filter(student => {
                const instrumentMatch = !instrumentFilter || student.instrument === instrumentFilter;
                const statusMatch = !statusFilter || 
                    (statusFilter === 'active' && student.active) ||
                    (statusFilter === 'inactive' && !student.active);
                return instrumentMatch && statusMatch;
            }).sort((a, b) => a.name.localeCompare(b.name));

            container.innerHTML = filteredStudents.map(student => {
                const scheduleText = student.startDate ? 
                    `${getDayName(student.regularDay)} ${student.regularTime} (desde ${student.startDate})` :
                    `${getDayName(student.regularDay)} ${student.regularTime}`;
                    
                return `
                    <div class="student-card ${student.active ? '' : 'inactive'}" onclick="showStudentDetails(${student.id})">
                        <div class="student-header">
                            <div class="student-name">${student.name}</div>
                            <div class="student-status ${student.active ? 'active' : 'inactive'}">
                                ${student.active ? 'Activo' : 'Inactivo'}
                            </div>
                        </div>
                        <div class="student-info">
                            <div><strong>Instrumento:</strong> ${student.instrument}</div>
                            <div><strong>Horario:</strong> ${scheduleText}</div>
                        </div>
                        ${student.licenseCredits > 0 ? `<div class="student-credits">💳 ${student.licenseCredits} créditos disponibles</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Detalles del alumno
        function showStudentDetails(studentId) {
            const student = students.find(s => s.id === studentId);
            const modal = document.getElementById('studentDetailsModal');
            const body = document.getElementById('studentDetailsBody');
            const footer = document.getElementById('studentDetailsFooter');
            
            const monthlyStats = getMonthlyAttendance(studentId);
            const studentRecoveries = specialClasses.filter(sc => 
                sc.studentId === studentId && sc.type === 'recovery'
            ).sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Información de horario con fecha de inicio
            const scheduleInfo = student.startDate ? 
                `${getDayName(student.regularDay)} ${student.regularTime} (desde ${student.startDate})` :
                `${getDayName(student.regularDay)} ${student.regularTime}`;
            
            body.innerHTML = `
                <div class="student-info">
                    <p><strong>Nombre:</strong> ${student.name}</p>
                    <p><strong>Instrumento:</strong> ${student.instrument}</p>
                    <p><strong>Horario:</strong> ${scheduleInfo}</p>
                    <p><strong>Estado:</strong> ${student.active ? 'Activo' : 'Inactivo'}</p>
                    <p><strong>Créditos:</strong> ${student.licenseCredits || 0}</p>
                    ${student.startDate ? `<p><strong>Fecha de inicio:</strong> ${student.startDate}</p>` : ''}
                </div>
                
                <h3>Asistencias por mes</h3>
                <div class="monthly-stats">
                    <div class="stat-box">
                        <div class="stat-number">${monthlyStats.present}</div>
                        <div class="stat-label">Presentes</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${monthlyStats.absent}</div>
                        <div class="stat-label">Ausentes</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${monthlyStats.licenses}</div>
                        <div class="stat-label">Licencias</div>
                    </div>
                </div>
                
                ${studentRecoveries.length > 0 ? `
                    <h3>Recuperaciones</h3>
                    <div class="recoveries-list">
                        ${studentRecoveries.map(recovery => {
                            const attendanceRecord = attendance.find(a => 
                                a.classId === recovery.id && a.date === recovery.date
                            );
                            const status = attendanceRecord?.status || 'pendiente';
                            return `
                                <div class="recovery-item">
                                    <span>${recovery.date} - ${recovery.time}</span>
                                    <span class="recovery-status ${status}">${getStatusText(status)}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                ` : ''}
            `;
            
            footer.innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">Cerrar</button>
                <button class="btn btn-primary" onclick="editStudent(${studentId})">Editar</button>
                ${student.active ? `<button class="btn btn-absent" onclick="confirmDeactivateStudent(${studentId})">Desactivar</button>` : 
                                `<button class="btn btn-success" onclick="reactivateStudent(${studentId})">Reactivar</button>`}
            `;
            
            modal.classList.add('active');
        }

        // Formulario de estudiante
        function openStudentForm(editId = null) {
            const modal = document.getElementById('studentModal');
            const title = document.getElementById('studentModalTitle');
            const form = document.getElementById('studentForm');
            
            currentEditingStudent = editId;
            title.textContent = editId ? 'Editar Alumno' : 'Agregar Alumno';
            
            ensureStartDateField();
            
            if (editId) {
                const student = students.find(s => s.id === editId);
                if (student) {
                    document.getElementById('studentName').value = student.name;
                    document.getElementById('studentInstrument').value = student.instrument;
                    document.getElementById('studentDay').value = student.regularDay;
                    
                    populateTimeSlots();
                    setTimeout(() => {
                        document.getElementById('studentTime').value = student.regularTime;
                        
                        if (student.startDate) {
                            document.getElementById('studentStartDate').value = student.startDate;
                        }
                    }, 50);
                }
                
                document.getElementById('studentStartDate').removeAttribute('required');
                
            } else {
                form.reset();
                populateTimeSlots();
                
                // Para nuevo alumno, permitir fechas desde inicio del mes actual
                const firstDayOfMonth = new Date();
                firstDayOfMonth.setDate(1);
                const firstDayStr = firstDayOfMonth.toISOString().split('T')[0];
                
                document.getElementById('studentStartDate').min = firstDayStr;
                document.getElementById('studentStartDate').value = new Date().toISOString().split('T')[0];
            }
            
            modal.classList.add('active');
        }

        // NUEVA: Asegurar que el campo de fecha de inicio existe en el formulario
        function ensureStartDateField() {
            let startDateField = document.getElementById('studentStartDateGroup');
            
            if (!startDateField) {
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';
                formGroup.id = 'studentStartDateGroup';
                formGroup.innerHTML = `
                    <label class="form-label">Fecha de inicio de clases (opcional)</label>
                    <input type="date" class="form-input" id="studentStartDate">
                    <small style="color: var(--text-light); font-size: 0.8rem;">
                        Fechas pasadas generarán licencias automáticas por días perdidos
                    </small>
                `;
                
                const modalFooter = document.querySelector('#studentModal .modal-footer');
                modalFooter.parentNode.insertBefore(formGroup, modalFooter);
            }
        }

        function editStudent(studentId) {
            closeModal();
            openStudentForm(studentId);
        }

        function saveStudent() {
            const name = document.getElementById('studentName').value.trim();
            const instrument = document.getElementById('studentInstrument').value;
            const day = parseInt(document.getElementById('studentDay').value);
            const time = document.getElementById('studentTime').value;
            const startDate = document.getElementById('studentStartDate').value || null;
            
            if (!name || !instrument || !day || !time) {
                showToast('Por favor completa todos los campos obligatorios');
                return;
            }
            
            const scheduleValidation = validateUniqueSchedule(day, time, currentEditingStudent);
            
            if (scheduleValidation === false) {
                showToast('Este horario ya está ocupado por otro alumno activo');
                return;
            }
            
            // Validar que la fecha de inicio sea correcta si hay conflicto
            if (typeof scheduleValidation === 'string' && startDate) {
                const conflictEndDate = new Date(scheduleValidation);
                const selectedStartDate = new Date(startDate);
                
                if (selectedStartDate < conflictEndDate) {
                    showToast(`La fecha de inicio debe ser posterior al ${scheduleValidation}`);
                    return;
                }
            }
            
            if (currentEditingStudent) {
                updateExistingStudent(currentEditingStudent, name, instrument, day, time, startDate);
            } else {
                createNewStudent(name, instrument, day, time, startDate);
            }
        }

        function createNewStudent(name, instrument, day, time, startDate = null) {
            const newStudentId = Date.now() + Math.floor(Math.random() * 1000);
            
            const newStudent = {
                id: newStudentId,
                name: name,
                instrument: instrument,
                regularDay: day,
                regularTime: time,
                active: true,
                licenseCredits: 0,
                createdAt: new Date().toISOString(),
                startDate: startDate || null
            };
            
            const newRegularClass = {
                id: Date.now() + Math.floor(Math.random() * 1000) + 1,
                studentId: newStudentId,
                day: day,
                time: time
            };
            
            students.push(newStudent);
            regularClasses.push(newRegularClass);
            
            // Generar auto-licencias para fechas pasadas del mes actual
            generateAutoLicensesForPastDates(newStudent, newRegularClass);
            
            saveData();
            renderStudentsList();
            renderWeekView();
            closeModal();
            
            const startMessage = startDate ? ` (inicia el ${startDate})` : '';
            showToast(`✅ Alumno ${name} inscrito exitosamente${startMessage}`);
        }

        // NUEVA: Generar licencias automáticas para fechas pasadas
        function generateAutoLicensesForPastDates(student, regularClass) {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            // Obtener primer día del mes actual
            const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
            
            // Determinar fecha de inicio efectiva
            const effectiveStartDate = student.startDate ? new Date(student.startDate) : today;
            
            // Si la fecha de inicio es en el futuro, no generar auto-licencias
            if (effectiveStartDate > today) return;
            
            // Generar fechas de clases pasadas desde inicio de mes hasta hoy
            const pastClassDates = [];
            const startDate = effectiveStartDate < firstDayOfMonth ? firstDayOfMonth : effectiveStartDate;
            
            for (let d = new Date(startDate); d < today; d.setDate(d.getDate() + 1)) {
                // Verificar si coincide con el día de clase del alumno
                if (d.getDay() === (student.regularDay === 6 ? 6 : student.regularDay % 7)) {
                    pastClassDates.push(new Date(d));
                }
            }
            
            // Crear licencias automáticas para fechas pasadas
            pastClassDates.forEach(date => {
                const dateStr = date.toISOString().split('T')[0];
                
                // Verificar que no exista ya una asistencia registrada
                const existingAttendance = attendance.find(a => 
                    a.classId === regularClass.id && a.date === dateStr
                );
                
                if (!existingAttendance) {
                    // Crear licencia automática
                    specialClasses.push({
                        id: Date.now() + Math.random(),
                        studentId: student.id,
                        date: dateStr,
                        time: student.regularTime,
                        type: 'license',
                        originalClassId: regularClass.id,
                        autoGenerated: true,
                        reason: 'Inscripción tardía'
                    });
                    
                    // Agregar crédito de recuperación
                    student.licenseCredits = (student.licenseCredits || 0) + 1;
                    
                    // Registrar asistencia como licencia
                    attendance.push({
                        classId: regularClass.id,
                        date: dateStr,
                        status: 'license',
                        timestamp: Date.now(),
                        autoGenerated: true
                    });
                }
            });
            
            if (pastClassDates.length > 0) {
                console.log(`✅ ${pastClassDates.length} auto-licencias generadas para ${student.name}`);
            }
        }

        function debugStudentData() {
            console.log('=== DEBUG STUDENT DATA ===');
            console.log('Students:', students.length);
            console.log('Regular Classes:', regularClasses.length);
            
            students.forEach(s => {
                const rc = regularClasses.find(rc => rc.studentId === s.id);
                console.log(`${s.name}: Student(${s.regularDay}, ${s.regularTime}) | Class(${rc?.day}, ${rc?.time}) | Active: ${s.active}`);
            });
        }

        // HELPER: Convertir día del sistema (1-6) a día de Date (0-6)
        function getDateDayFromSystemDay(systemDay) {
            // Sistema: 1=Lun, 2=Mar, 3=Mié, 4=Jue, 5=Vie, 6=Sáb
            // Date: 0=Dom, 1=Lun, 2=Mar, 3=Mié, 4=Jue, 5=Vie, 6=Sáb
            return systemDay === 6 ? 6 : systemDay;
        }

        // HELPER: Convertir día de Date (0-6) a día del sistema (1-6)
        function getSystemDayFromDateDay(dateDay) {
            // Date: 0=Dom, 1=Lun, 2=Mar, 3=Mié, 4=Jue, 5=Vie, 6=Sáb
            // Sistema: 1=Lun, 2=Mar, 3=Mié, 4=Jue, 5=Vie, 6=Sáb
            return dateDay === 0 ? null : dateDay; // No manejamos domingo
        }

        function setupScheduleValidation() {
            const daySelect = document.getElementById('studentDay');
            const timeSelect = document.getElementById('studentTime');
            
            const validateScheduleInputs = () => {
                const day = parseInt(daySelect.value);
                const time = timeSelect.value;
                
                if (day && time) {
                    const validation = validateUniqueSchedule(day, time, currentEditingStudent);
                    const submitBtn = document.querySelector('#studentForm .btn-primary');
                    const startDateInput = document.getElementById('studentStartDate');
                    
                    if (validation === false) {
                        timeSelect.style.borderColor = '#ef4444';
                        submitBtn.textContent = 'Horario ocupado';
                        submitBtn.disabled = true;
                        startDateInput.disabled = true;
                    } else if (typeof validation === 'string') {
                        // Horario se libera en fecha futura
                        timeSelect.style.borderColor = '#f59e0b';
                        submitBtn.textContent = 'Inscribir';
                        submitBtn.disabled = false;
                        startDateInput.disabled = false;
                        startDateInput.min = validation;
                        startDateInput.value = validation;
                        
                        const helpText = startDateInput.parentNode.querySelector('small');
                        helpText.textContent = `Horario disponible desde: ${validation}`;
                        helpText.style.color = '#f59e0b';
                    } else {
                        // Horario disponible - permitir fechas desde inicio de mes
                        timeSelect.style.borderColor = '#10b981';
                        submitBtn.textContent = currentEditingStudent ? 'Actualizar' : 'Guardar';
                        submitBtn.disabled = false;
                        startDateInput.disabled = false;
                        
                        // Permitir fechas desde primer día del mes actual
                        const firstDayOfMonth = new Date();
                        firstDayOfMonth.setDate(1);
                        const firstDayStr = firstDayOfMonth.toISOString().split('T')[0];
                        startDateInput.min = firstDayStr;
                        
                        const helpText = startDateInput.parentNode.querySelector('small');
                        helpText.textContent = 'Fechas pasadas generarán licencias automáticas por días perdidos';
                        helpText.style.color = 'var(--text-light)';
                    }
                }
            };
            
            daySelect.addEventListener('change', validateScheduleInputs);
            timeSelect.addEventListener('change', validateScheduleInputs);
        }


        // NUEVA: Actualizar estudiante existente
        function updateExistingStudent(studentId, name, instrument, day, time, startDate = null) {
            const student = students.find(s => s.id === studentId);
            
            student.name = name;
            student.instrument = instrument;
            student.regularDay = day;
            student.regularTime = time;
            student.startDate = startDate || student.startDate; // Mantener existente si no se cambia
            student.updatedAt = new Date().toISOString();
            
            let regularClass = regularClasses.find(rc => rc.studentId === studentId);
            if (regularClass) {
                regularClass.day = day;
                regularClass.time = time;
            } else {
                regularClass = {
                    id: Date.now() + Math.floor(Math.random() * 1000),
                    studentId: studentId,
                    day: day,
                    time: time
                };
                regularClasses.push(regularClass);
            }
            
            saveData();
            renderStudentsList();
            renderWeekView();
            closeModal();
            
            showToast(`✅ Alumno ${name} actualizado exitosamente`);
        }


        // Horarios disponibles
        function populateTimeSlots() {
            const timeSelect = document.getElementById('studentTime');
            timeSelect.innerHTML = '<option value="">Seleccionar...</option>';
            
            timeSlots.forEach(time => {
                timeSelect.innerHTML += `<option value="${time}">${time}</option>`;
            });
        }

        // Validar horario único
        function validateUniqueSchedule(day, time, excludeId = null, allowFutureStart = true) {
            const conflictingStudent = students.find(s => 
                s.id !== excludeId && 
                s.regularDay == day && 
                s.regularTime === time &&
                s.active
            );
            
            if (!conflictingStudent) return true;
            
            // Si hay conflicto pero el alumno está desactivado con fecha futura
            if (allowFutureStart && conflictingStudent.deactivatedAt) {
                return conflictingStudent.deactivatedAt; // Retorna fecha de disponibilidad
            }
            
            return false;
        } 

        // Estadísticas mensuales
        function getMonthlyAttendance(studentId) {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            // Asistencias de clases regulares
            const studentRegularClass = regularClasses.find(rc => rc.studentId === studentId);
            let regularAttendance = [];
            if (studentRegularClass) {
                regularAttendance = attendance.filter(a => {
                    const date = new Date(a.date);
                    return date.getMonth() === currentMonth && 
                        date.getFullYear() === currentYear &&
                        a.classId === studentRegularClass.id;
                });
            }
            
            // Asistencias de recuperaciones
            const studentRecoveries = specialClasses.filter(sc => 
                sc.studentId === studentId && sc.type === 'recovery'
            );
            
            const recoveryAttendance = attendance.filter(a => {
                const date = new Date(a.date);
                const isCurrentMonth = date.getMonth() === currentMonth && date.getFullYear() === currentYear;
                const isStudentRecovery = studentRecoveries.some(recovery => recovery.id === a.classId);
                return isCurrentMonth && isStudentRecovery;
            });
            
            // Combinar ambas asistencias
            const allAttendance = [...regularAttendance, ...recoveryAttendance];
            
            return {
                present: allAttendance.filter(a => a.status === 'present').length,
                absent: allAttendance.filter(a => a.status === 'absent').length,
                licenses: allAttendance.filter(a => a.status === 'license').length
            };
        }

        // Desactivar estudiante
        function confirmDeactivateStudent(studentId) {
            // Implementar modal de confirmación con fecha
            showToast('Modal de desactivación en desarrollo');
        }

        function reactivateStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            student.active = true;
            student.deactivatedAt = null;
            saveData();
            renderStudentsList();
            closeModal();
            showToast('Alumno reactivado');
        }

        // FAB para agregar
        function updateFabAction() {
            const fab = document.querySelector('.fab');
            const studentsVisible = document.getElementById('studentsSection').style.display !== 'none';
            
            if (studentsVisible) {
                fab.innerHTML = '<svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="3"><path d="M12 5v14m7-7H5"/></svg>';
                fab.onclick = () => openStudentForm();
            } else {
                fab.innerHTML = '<svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="3"><path d="M9 11l3 3L22 4"/></svg>';
                fab.onclick = openAttendanceMode;
            }
        }

        // Eventos
        document.getElementById('instrumentFilter').addEventListener('change', renderStudentsList);
        document.getElementById('statusFilter').addEventListener('change', renderStudentsList);


        // Actualizar switchTab
        function switchTab(tab) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            document.querySelector('.main-content').style.display = tab === 'calendar' ? 'block' : 'none';
            document.getElementById('studentsSection').style.display = tab === 'students' ? 'block' : 'none';
            
            if (tab === 'students') {
                renderStudentsList();
                populateTimeSlots();
                updateFabAction();
            } else if (tab === 'calendar') {
                updateFabAction();
            } else {
                showToast(`Sección ${tab} en desarrollo`);
            }
        }

        // Desactivación con fecha
        function confirmDeactivateStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            const modal = document.getElementById('deactivateModal');
            
            document.getElementById('deactivateStudentName').textContent = `¿Desactivar a ${student.name}?`;
            document.getElementById('deactivateDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('deactivateDate').min = new Date().toISOString().split('T')[0];
            
            closeModal();
            modal.classList.add('active');
            
            document.getElementById('deactivateForm').onsubmit = (e) => {
                e.preventDefault();
                const fromDate = document.getElementById('deactivateDate').value;
                deactivateStudent(studentId, fromDate);
            };
        }

        function deactivateStudent(studentId, fromDate) {
            const student = students.find(s => s.id === studentId);
            student.active = false;
            student.deactivatedAt = fromDate;
            
            cancelFutureClasses(studentId, fromDate);
            
            saveData();
            renderStudentsList();
            renderWeekView();
            closeModal();
            showToast('Alumno desactivado y clases futuras canceladas');
        }

        function cancelFutureClasses(studentId, fromDate) {
            const fromDateObj = new Date(fromDate);
            
            // Solo cancelar recuperaciones futuras (después de la fecha de corte)
            const recoveriesToCancel = specialClasses.filter(sc => {
                if (sc.studentId === studentId && sc.type === 'recovery') {
                    const classDate = new Date(sc.date);
                    return classDate >= fromDateObj;
                }
                return false;
            });
            
            // Eliminar recuperaciones futuras y restaurar créditos
            recoveriesToCancel.forEach(recovery => {
                const student = students.find(s => s.id === studentId);
                if (student) {
                    student.licenseCredits = (student.licenseCredits || 0) + 1;
                }
            });
            
            // Filtrar specialClasses
            specialClasses = specialClasses.filter(sc => {
                if (sc.studentId === studentId && sc.type === 'recovery') {
                    const classDate = new Date(sc.date);
                    return classDate < fromDateObj; // Mantener solo las anteriores
                }
                return true;
            });
            
            // NO eliminar asistencias - mantener historial completo
            // Las asistencias se conservan para estadísticas y registro histórico
            
            console.log(`✅ Alumno ${studentId} desactivado desde ${fromDate}. Historial conservado.`);
        }

        // NUEVA: Función para verificar disponibilidad de horario en fecha específica
        function isScheduleAvailableOnDate(day, time, date, excludeStudentId = null) {
            return !students.some(s => 
                s.id !== excludeStudentId &&
                s.regularDay === day && 
                s.regularTime === time &&
                isStudentActiveOnDate(s, date)
            );
        }

        // NUEVA: Obtener información de ocupación de horario
        function getScheduleOccupancyInfo(day, time) {
            const student = students.find(s => s.regularDay === day && s.regularTime === time);
            
            if (!student) {
                return { available: true, message: 'Horario disponible' };
            }
            
            if (student.active) {
                return { 
                    available: false, 
                    message: `Ocupado por ${student.name} (activo)`,
                    student: student
                };
            }
            
            if (student.deactivatedAt) {
                return {
                    available: false,
                    message: `Ocupado por ${student.name} hasta ${student.deactivatedAt}`,
                    student: student,
                    availableFrom: student.deactivatedAt
                };
            }
            
            return { available: true, message: 'Horario disponible' };
        }

        // Migrar datos existentes
        function migrateStudentData() {
            students.forEach(student => {
                if (student.day && !student.regularDay) {
                    student.regularDay = student.day;
                    student.regularTime = student.time;
                    delete student.day;
                    delete student.time;
                }
            });
            
            regularClasses.forEach(rc => {
                const student = students.find(s => s.id === rc.studentId);
                if (student && !student.regularDay) {
                    student.regularDay = rc.day;
                    student.regularTime = rc.time;
                }
            });
        }

        // Actualizar FAB
        function updateFabAction() {
            const fab = document.querySelector('.fab');
            const studentsVisible = document.getElementById('studentsSection').style.display !== 'none';
            
            if (studentsVisible) {
                fab.innerHTML = '<svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="3"><path d="M12 5v14m7-7H5"/></svg>';
                fab.onclick = () => openStudentForm();
            } else {
                fab.innerHTML = '<svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="3"><path d="M9 11l3 3L22 4"/></svg>';
                fab.onclick = openAttendanceMode;
            }
        }

        // Nueva función helper para verificar si alumno está activo en fecha específica
        function isStudentActiveOnDate(student, targetDate) {
            // Verificar fecha de inicio (si existe)
            if (student.startDate) {
                const startDate = new Date(student.startDate);
                const checkDate = new Date(targetDate);
                if (checkDate < startDate) return false;
            }
            
            // Verificar si está activo globalmente
            if (student.active) return true;
            
            // Verificar fecha de desactivación
            if (student.deactivatedAt) {
                const deactivationDate = new Date(student.deactivatedAt);
                const checkDate = new Date(targetDate);
                return checkDate < deactivationDate;
            }
            
            return false;
        }

        // Función helper para obtener fecha de una clase en semana específica
        function getClassDateInWeek(day, weekStartDate) {
            const classDate = new Date(weekStartDate);
            // day: 1=Lun, 2=Mar, 3=Mié, 4=Jue, 5=Vie, 6=Sáb
            classDate.setDate(classDate.getDate() + (day - 1));
            return classDate;
        }
    </script>
</body>
</html>